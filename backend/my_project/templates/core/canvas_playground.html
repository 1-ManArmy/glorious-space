{% extends 'base.html' %}
{% load static %}

{% block title %}Canvas Playground - Create Amazing Art{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/canvas.css' %}">
<style>
    .canvas-container {
        background: #f8f9fa;
        min-height: calc(100vh - 100px);
        padding: 20px 0;
    }
    
    .canvas-workspace {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .canvas-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
    }
    
    .canvas-type-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .canvas-type-btn {
        flex: 1;
        padding: 15px;
        border: 2px solid transparent;
        background: rgba(255,255,255,0.1);
        color: white;
        border-radius: 10px;
        text-decoration: none;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .canvas-type-btn:hover,
    .canvas-type-btn.active {
        border-color: #ffc107;
        background: rgba(255,193,7,0.2);
        color: white;
        text-decoration: none;
    }
    
    .canvas-tools {
        background: #f8f9fa;
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .tool-group {
        margin-bottom: 20px;
    }
    
    .tool-btn {
        width: 40px;
        height: 40px;
        border: 1px solid #dee2e6;
        background: white;
        margin-right: 5px;
        border-radius: 5px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .tool-btn:hover,
    .tool-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .canvas-main {
        display: flex;
        height: 70vh;
    }
    
    .canvas-sidebar {
        width: 280px;
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
        padding: 20px;
        overflow-y: auto;
    }
    
    .canvas-area {
        flex: 1;
        position: relative;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #mainCanvas {
        border: 1px solid #dee2e6;
        cursor: crosshair;
        max-width: 100%;
        max-height: 100%;
    }
    
    .properties-panel {
        width: 280px;
        background: #f8f9fa;
        border-left: 1px solid #dee2e6;
        padding: 20px;
        overflow-y: auto;
    }
    
    .color-picker {
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
    }
    
    .brush-size-slider {
        width: 100%;
        margin: 10px 0;
    }
    
    .layer-item {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 5px;
        cursor: pointer;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .layer-item.active {
        border-color: #667eea;
        background: #f0f4ff;
    }
    
    .collaboration-panel {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    
    .user-cursor {
        position: absolute;
        pointer-events: none;
        z-index: 1000;
        transition: all 0.1s ease;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
    }
    
    .canvas-footer {
        background: #f8f9fa;
        padding: 15px 20px;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .save-status {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .save-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #28a745;
    }
    
    .save-indicator.saving {
        background: #ffc107;
        animation: pulse 1s infinite;
    }
    
    .save-indicator.error {
        background: #dc3545;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .canvas-zoom-controls {
        display: flex;
        gap: 5px;
        align-items: center;
    }
    
    .zoom-btn {
        width: 30px;
        height: 30px;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    .performance-monitor {
        position: fixed;
        top: 80px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        z-index: 1000;
        display: none;
    }
    
    .chat-panel {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 300px;
        height: 400px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        display: none;
        flex-direction: column;
        z-index: 1000;
    }
    
    .chat-header {
        background: #667eea;
        color: white;
        padding: 15px;
        border-radius: 10px 10px 0 0;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
    }
    
    .chat-input {
        padding: 15px;
        border-top: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="canvas-container">
    <div class="container-fluid">
        <div class="canvas-workspace">
            <!-- Canvas Header -->
            <div class="canvas-header">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">
                        <i class="fas fa-palette me-2"></i>
                        Canvas Playground
                    </h3>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light btn-sm" id="shareBtn">
                            <i class="fas fa-share-alt me-1"></i>Share
                        </button>
                        <button class="btn btn-outline-light btn-sm" id="saveBtn">
                            <i class="fas fa-save me-1"></i>Save
                        </button>
                        <button class="btn btn-warning btn-sm" id="exportBtn">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                    </div>
                </div>
                
                <!-- Canvas Type Selector -->
                <div class="canvas-type-selector">
                    <a href="?type=2d" class="canvas-type-btn {% if canvas_type == '2d' %}active{% endif %}">
                        <i class="fas fa-draw-polygon d-block mb-2"></i>
                        <strong>2D Canvas</strong>
                        <small class="d-block">Draw & Paint</small>
                    </a>
                    <a href="?type=3d" class="canvas-type-btn {% if canvas_type == '3d' %}active{% endif %}">
                        <i class="fas fa-cube d-block mb-2"></i>
                        <strong>3D WebGL</strong>
                        <small class="d-block">3D Modeling</small>
                    </a>
                    <a href="?type=4d" class="canvas-type-btn {% if canvas_type == '4d' %}active{% endif %}">
                        <i class="fas fa-atom d-block mb-2"></i>
                        <strong>4D Space</strong>
                        <small class="d-block">Temporal Art</small>
                    </a>
                    <a href="?type=5g" class="canvas-type-btn {% if canvas_type == '5g' %}active{% endif %}">
                        <i class="fas fa-broadcast-tower d-block mb-2"></i>
                        <strong>5G Real-time</strong>
                        <small class="d-block">Collaborative</small>
                    </a>
                </div>
            </div>
            
            <!-- Canvas Tools -->
            <div class="canvas-tools">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex flex-wrap gap-3">
                            {% if canvas_type == '2d' %}
                            <!-- 2D Tools -->
                            <div class="tool-group">
                                <label class="small fw-bold text-muted">Drawing Tools</label>
                                <div class="d-flex mt-1">
                                    <button class="tool-btn active" data-tool="brush" title="Brush">
                                        <i class="fas fa-paint-brush"></i>
                                    </button>
                                    <button class="tool-btn" data-tool="pencil" title="Pencil">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                    <button class="tool-btn" data-tool="eraser" title="Eraser">
                                        <i class="fas fa-eraser"></i>
                                    </button>
                                    <button class="tool-btn" data-tool="line" title="Line">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button class="tool-btn" data-tool="rectangle" title="Rectangle">
                                        <i class="fas fa-square"></i>
                                    </button>
                                    <button class="tool-btn" data-tool="circle" title="Circle">
                                        <i class="fas fa-circle"></i>
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if canvas_type == '3d' %}
                            <!-- 3D Tools -->
                            <div class="tool-group">
                                <label class="small fw-bold text-muted">3D Objects</label>
                                <div class="d-flex mt-1">
                                    <button class="tool-btn active" data-tool="select" title="Select">
                                        <i class="fas fa-mouse-pointer"></i>
                                    </button>
                                    <button class="tool-btn" data-tool="cube" title="Cube">
                                        <i class="fas fa-cube"></i>
                                    </button>
                                    <button class="tool-btn" data-tool="sphere" title="Sphere">
                                        <i class="fas fa-circle"></i>
                                    </button>
                                    <button class="tool-btn" data-tool="cylinder" title="Cylinder">
                                        <i class="fas fa-database"></i>
                                    </button>
                                    <button class="tool-btn" data-tool="light" title="Light">
                                        <i class="fas fa-lightbulb"></i>
                                    </button>
                                    <button class="tool-btn" data-tool="camera" title="Camera">
                                        <i class="fas fa-video"></i>
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="tool-group">
                                <label class="small fw-bold text-muted">Actions</label>
                                <div class="d-flex mt-1">
                                    <button class="tool-btn" id="undoBtn" title="Undo">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="tool-btn" id="redoBtn" title="Redo">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                    <button class="tool-btn" id="clearBtn" title="Clear">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 text-end">
                        <div class="d-flex gap-2 align-items-center justify-content-end">
                            <label class="small fw-bold text-muted">Collaboration</label>
                            <button class="btn btn-sm btn-outline-primary" id="collaborateBtn">
                                <i class="fas fa-users me-1"></i>Invite
                            </button>
                            <button class="btn btn-sm btn-outline-success" id="chatBtn">
                                <i class="fas fa-comments me-1"></i>Chat
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Canvas Main Area -->
            <div class="canvas-main">
                <!-- Sidebar -->
                <div class="canvas-sidebar">
                    {% if canvas_type == '2d' %}
                    <!-- 2D Sidebar -->
                    <div class="mb-4">
                        <h6 class="fw-bold">Brush Settings</h6>
                        <div class="mb-3">
                            <label class="form-label small">Color</label>
                            <input type="color" class="color-picker" id="colorPicker" value="#000000">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Size: <span id="brushSizeValue">10</span>px</label>
                            <input type="range" class="brush-size-slider" id="brushSize" min="1" max="100" value="10">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Opacity: <span id="opacityValue">100</span>%</label>
                            <input type="range" class="brush-size-slider" id="opacity" min="1" max="100" value="100">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="fw-bold">Layers</h6>
                        <div id="layersList">
                            <div class="layer-item active">
                                <span>Background</span>
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="layer-item">
                                <span>Layer 1</span>
                                <i class="fas fa-eye"></i>
                            </div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm w-100 mt-2" id="addLayerBtn">
                            <i class="fas fa-plus me-1"></i>Add Layer
                        </button>
                    </div>
                    {% endif %}
                    
                    {% if canvas_type == '3d' %}
                    <!-- 3D Sidebar -->
                    <div class="mb-4">
                        <h6 class="fw-bold">Scene Objects</h6>
                        <div id="objectsList">
                            <!-- Objects will be populated by JavaScript -->
                        </div>
                        <button class="btn btn-outline-primary btn-sm w-100 mt-2" id="addObjectBtn">
                            <i class="fas fa-plus me-1"></i>Add Object
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="fw-bold">Lighting</h6>
                        <div class="mb-2">
                            <label class="form-label small">Ambient Light</label>
                            <input type="range" class="form-range" id="ambientLight" min="0" max="1" step="0.1" value="0.4">
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Directional Light</label>
                            <input type="range" class="form-range" id="directionalLight" min="0" max="2" step="0.1" value="1">
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Collaboration Panel -->
                    <div class="collaboration-panel">
                        <h6 class="fw-bold mb-3">Active Users</h6>
                        <div id="activeUsers">
                            <div class="d-flex align-items-center mb-2">
                                <img src="{{ user.profile_picture|default:'/static/img/default-avatar.png' }}" 
                                     alt="{{ user.username }}" 
                                     class="rounded-circle me-2" 
                                     width="24" height="24">
                                <span class="small">{{ user.username }} (You)</span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-wifi me-1"></i>
                                Connected
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Canvas Area -->
                <div class="canvas-area" id="canvasArea">
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Initializing Canvas...</p>
                        </div>
                    </div>
                    
                    {% if canvas_type == '2d' %}
                        <canvas id="mainCanvas" width="800" height="600"></canvas>
                    {% elif canvas_type == '3d' %}
                        <div id="webglContainer" style="width: 800px; height: 600px;"></div>
                    {% elif canvas_type == '4d' %}
                        <div id="fourDContainer" style="width: 800px; height: 600px;"></div>
                    {% elif canvas_type == '5g' %}
                        <div id="fiveGContainer" style="width: 800px; height: 600px;">
                            <canvas id="realTimeCanvas" width="800" height="600"></canvas>
                            <div id="videoContainer"></div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Properties Panel -->
                <div class="properties-panel">
                    <h6 class="fw-bold">Properties</h6>
                    <div id="propertiesContent">
                        {% if canvas_type == '2d' %}
                        <p class="text-muted small">Select a tool to see properties</p>
                        {% elif canvas_type == '3d' %}
                        <p class="text-muted small">Select an object to see properties</p>
                        {% elif canvas_type == '4d' %}
                        <div class="mb-3">
                            <label class="form-label small">Time Dimension</label>
                            <input type="range" class="form-range" id="timeSlider" min="0" max="100" value="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Animation Speed</label>
                            <input type="range" class="form-range" id="animSpeed" min="0.1" max="5" step="0.1" value="1">
                        </div>
                        {% elif canvas_type == '5g' %}
                        <div class="mb-3">
                            <h6 class="small fw-bold">5G Features</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableWebRTC">
                                <label class="form-check-label small" for="enableWebRTC">
                                    WebRTC Video
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableAR">
                                <label class="form-check-label small" for="enableAR">
                                    AR Mode
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableEdgeComputing">
                                <label class="form-check-label small" for="enableEdgeComputing">
                                    Edge Computing
                                </label>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="mt-4">
                        <h6 class="fw-bold">Performance</h6>
                        <div id="performanceStats">
                            <div class="d-flex justify-content-between">
                                <small>FPS:</small>
                                <small id="fpsCounter">60</small>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small>Latency:</small>
                                <small id="latencyCounter">5ms</small>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small>Memory:</small>
                                <small id="memoryCounter">12MB</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Canvas Footer -->
            <div class="canvas-footer">
                <div class="save-status">
                    <div class="save-indicator" id="saveIndicator"></div>
                    <span class="small" id="saveStatus">All changes saved</span>
                </div>
                
                <div class="canvas-zoom-controls">
                    <button class="zoom-btn" id="zoomOut" title="Zoom Out">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span class="small mx-2" id="zoomLevel">100%</span>
                    <button class="zoom-btn" id="zoomIn" title="Zoom In">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="zoom-btn ms-2" id="fitToScreen" title="Fit to Screen">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Monitor -->
<div class="performance-monitor" id="performanceMonitor">
    <div>FPS: <span id="detailedFPS">60</span></div>
    <div>Frame Time: <span id="frameTime">16.7ms</span></div>
    <div>Draw Calls: <span id="drawCalls">1</span></div>
    <div>Vertices: <span id="vertices">0</span></div>
    <div>WebSocket: <span id="wsStatus">Connected</span></div>
</div>

<!-- Chat Panel -->
<div class="chat-panel" id="chatPanel">
    <div class="chat-header">
        <h6 class="mb-0">Collaboration Chat</h6>
        <button class="btn btn-sm btn-outline-light" id="closeChatBtn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="text-center text-muted small">
            Start chatting with your collaborators
        </div>
    </div>
    <div class="chat-input">
        <div class="input-group">
            <input type="text" class="form-control" id="chatInput" placeholder="Type a message...">
            <button class="btn btn-primary" id="sendChatBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Three.js for 3D Canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<!-- Canvas JavaScript -->
<script src="{% static 'js/canvas.js' %}"></script>
<script src="{% static 'js/webgl.js' %}"></script>
<script src="{% static 'js/5g_integration.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const canvasType = '{{ canvas_type }}';
    let canvasEngine = null;
    
    // Initialize Canvas based on type
    switch(canvasType) {
        case '2d':
            initializeCanvas2D();
            break;
        case '3d':
            initializeCanvas3D();
            break;
        case '4d':
            initializeCanvas4D();
            break;
        case '5g':
            initializeCanvas5G();
            break;
        default:
            initializeCanvas2D();
    }
    
    function initializeCanvas2D() {
        const canvas = document.getElementById('mainCanvas');
        if (!canvas) return;
        
        canvasEngine = new Canvas2D(canvas, {
            userId: '{{ user.id }}',
            username: '{{ user.username }}',
            roomId: 'playground-{{ user.id }}-{{ canvas_type }}'
        });
        
        // Setup 2D tools
        setupCanvas2DTools();
        hideLoadingOverlay();
    }
    
    function initializeCanvas3D() {
        const container = document.getElementById('webglContainer');
        if (!container) return;
        
        canvasEngine = new Canvas3D(container, {
            userId: '{{ user.id }}',
            username: '{{ user.username }}',
            roomId: 'playground-{{ user.id }}-{{ canvas_type }}'
        });
        
        // Setup 3D tools
        setupCanvas3DTools();
        hideLoadingOverlay();
    }
    
    function initializeCanvas4D() {
        // 4D is an extension of 3D with time dimension
        const container = document.getElementById('fourDContainer');
        if (!container) return;
        
        // Create a 3D canvas first
        canvasEngine = new Canvas3D(container, {
            userId: '{{ user.id }}',
            username: '{{ user.username }}',
            roomId: 'playground-{{ user.id }}-{{ canvas_type }}',
            mode: '4d'
        });
        
        // Setup 4D time controls
        setupCanvas4DTools();
        hideLoadingOverlay();
    }
    
    function initializeCanvas5G() {
        const container = document.getElementById('fiveGContainer');
        if (!container) return;
        
        canvasEngine = new FiveGIntegration(container, {
            userId: '{{ user.id }}',
            username: '{{ user.username }}',
            roomId: 'playground-{{ user.id }}-{{ canvas_type }}'
        });
        
        // Setup 5G tools
        setupCanvas5GTools();
        hideLoadingOverlay();
    }
    
    function hideLoadingOverlay() {
        setTimeout(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
        }, 1000);
    }
    
    function setupCanvas2DTools() {
        // Tool selection
        document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tool-btn[data-tool]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                if (canvasEngine) {
                    canvasEngine.setTool(this.dataset.tool);
                }
            });
        });
        
        // Color picker
        document.getElementById('colorPicker').addEventListener('change', function() {
            if (canvasEngine) {
                canvasEngine.setColor(this.value);
            }
        });
        
        // Brush size
        const brushSize = document.getElementById('brushSize');
        brushSize.addEventListener('input', function() {
            document.getElementById('brushSizeValue').textContent = this.value;
            if (canvasEngine) {
                canvasEngine.setBrushSize(this.value);
            }
        });
        
        // Opacity
        const opacity = document.getElementById('opacity');
        opacity.addEventListener('input', function() {
            document.getElementById('opacityValue').textContent = this.value;
            if (canvasEngine) {
                canvasEngine.setOpacity(this.value / 100);
            }
        });
    }
    
    function setupCanvas3DTools() {
        // 3D tool selection
        document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tool-btn[data-tool]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                if (canvasEngine) {
                    canvasEngine.setTool(this.dataset.tool);
                }
            });
        });
        
        // Lighting controls
        document.getElementById('ambientLight').addEventListener('input', function() {
            if (canvasEngine) {
                canvasEngine.setAmbientLight(this.value);
            }
        });
        
        document.getElementById('directionalLight').addEventListener('input', function() {
            if (canvasEngine) {
                canvasEngine.setDirectionalLight(this.value);
            }
        });
    }
    
    function setupCanvas4DTools() {
        setupCanvas3DTools(); // 4D includes 3D tools
        
        // Time dimension control
        document.getElementById('timeSlider').addEventListener('input', function() {
            if (canvasEngine) {
                canvasEngine.setTimePosition(this.value / 100);
            }
        });
        
        // Animation speed
        document.getElementById('animSpeed').addEventListener('input', function() {
            if (canvasEngine) {
                canvasEngine.setAnimationSpeed(this.value);
            }
        });
    }
    
    function setupCanvas5GTools() {
        // 5G feature toggles
        document.getElementById('enableWebRTC').addEventListener('change', function() {
            if (canvasEngine) {
                canvasEngine.toggleWebRTC(this.checked);
            }
        });
        
        document.getElementById('enableAR').addEventListener('change', function() {
            if (canvasEngine) {
                canvasEngine.toggleAR(this.checked);
            }
        });
        
        document.getElementById('enableEdgeComputing').addEventListener('change', function() {
            if (canvasEngine) {
                canvasEngine.toggleEdgeComputing(this.checked);
            }
        });
    }
    
    // Global controls
    document.getElementById('undoBtn').addEventListener('click', function() {
        if (canvasEngine && canvasEngine.undo) {
            canvasEngine.undo();
        }
    });
    
    document.getElementById('redoBtn').addEventListener('click', function() {
        if (canvasEngine && canvasEngine.redo) {
            canvasEngine.redo();
        }
    });
    
    document.getElementById('clearBtn').addEventListener('click', function() {
        if (canvasEngine && canvasEngine.clear) {
            if (confirm('Are you sure you want to clear the canvas?')) {
                canvasEngine.clear();
            }
        }
    });
    
    // Save functionality
    document.getElementById('saveBtn').addEventListener('click', function() {
        if (canvasEngine && canvasEngine.save) {
            document.getElementById('saveIndicator').classList.add('saving');
            document.getElementById('saveStatus').textContent = 'Saving...';
            
            canvasEngine.save().then(() => {
                document.getElementById('saveIndicator').classList.remove('saving');
                document.getElementById('saveStatus').textContent = 'All changes saved';
            }).catch(() => {
                document.getElementById('saveIndicator').classList.add('error');
                document.getElementById('saveStatus').textContent = 'Save failed';
            });
        }
    });
    
    // Export functionality
    document.getElementById('exportBtn').addEventListener('click', function() {
        if (canvasEngine && canvasEngine.export) {
            canvasEngine.export();
        }
    });
    
    // Zoom controls
    document.getElementById('zoomIn').addEventListener('click', function() {
        if (canvasEngine && canvasEngine.zoomIn) {
            canvasEngine.zoomIn();
            updateZoomLevel();
        }
    });
    
    document.getElementById('zoomOut').addEventListener('click', function() {
        if (canvasEngine && canvasEngine.zoomOut) {
            canvasEngine.zoomOut();
            updateZoomLevel();
        }
    });
    
    document.getElementById('fitToScreen').addEventListener('click', function() {
        if (canvasEngine && canvasEngine.fitToScreen) {
            canvasEngine.fitToScreen();
            updateZoomLevel();
        }
    });
    
    function updateZoomLevel() {
        if (canvasEngine && canvasEngine.getZoom) {
            const zoom = Math.round(canvasEngine.getZoom() * 100);
            document.getElementById('zoomLevel').textContent = zoom + '%';
        }
    }
    
    // Chat functionality
    document.getElementById('chatBtn').addEventListener('click', function() {
        document.getElementById('chatPanel').style.display = 'flex';
    });
    
    document.getElementById('closeChatBtn').addEventListener('click', function() {
        document.getElementById('chatPanel').style.display = 'none';
    });
    
    document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });
    
    function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (message && canvasEngine && canvasEngine.sendChatMessage) {
            canvasEngine.sendChatMessage(message);
            input.value = '';
        }
    }
    
    // Performance monitoring
    let fpsCounter = 0;
    let lastTime = performance.now();
    
    function updatePerformanceStats() {
        const now = performance.now();
        const delta = now - lastTime;
        lastTime = now;
        
        fpsCounter = Math.round(1000 / delta);
        
        document.getElementById('fpsCounter').textContent = fpsCounter;
        document.getElementById('detailedFPS').textContent = fpsCounter;
        document.getElementById('frameTime').textContent = delta.toFixed(1) + 'ms';
        
        if (canvasEngine && canvasEngine.getStats) {
            const stats = canvasEngine.getStats();
            document.getElementById('drawCalls').textContent = stats.drawCalls || 1;
            document.getElementById('vertices').textContent = stats.vertices || 0;
            document.getElementById('memoryCounter').textContent = stats.memory || '12MB';
            document.getElementById('latencyCounter').textContent = stats.latency || '5ms';
        }
        
        requestAnimationFrame(updatePerformanceStats);
    }
    
    updatePerformanceStats();
    
    // Toggle performance monitor
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F3') {
            e.preventDefault();
            const monitor = document.getElementById('performanceMonitor');
            monitor.style.display = monitor.style.display === 'none' ? 'block' : 'none';
        }
    });
    
    // Collaboration
    document.getElementById('collaborateBtn').addEventListener('click', function() {
        // TODO: Implement collaboration invite modal
        alert('Collaboration invite feature coming soon!');
    });
});
</script>
{% endblock %}
